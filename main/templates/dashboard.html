{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">

    <h2 class="text-center fw-bold">Priyelle Glow â€“ Skin Analysis</h2>
    <p class="text-center text-muted">
        Capture your face to receive personalized skincare and makeup recommendations.
    </p>

    <!-- CAMERA SECTION -->
    
<div class="card shadow-lg p-4 text-center">
    <!-- CAMERA -->
    <div class="camera-wrapper mx-auto mb-3">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>
    
    <!-- FORM -->
    <form method="post" enctype="multipart/form-data" id="analysisForm">
        {% csrf_token %}
        <input type="hidden" name="captured_image" id="captured_image">
        
        <!-- BUTTONS -->
        <button type="button" class="btn btn-outline-primary w-100 mb-3 rounded-pill"
                onclick="captureImage()">
            ðŸ“¸ Capture Image
        </button>
        
        <button type="submit" class="btn btn-primary w-100"
                onclick="return submitAnalysis()">
            Analyze My Skin âœ¨
        </button>
    </form>
    
    <!-- LOADING -->
    <div id="loadingOverlay" style="display:none;" class="mt-3">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2">Analyzing your skin...</p>
    </div>
</div>

    <!-- MESSAGES/FEEDBACK SECTION - ADD THIS -->
    <div class="row justify-content-center mt-3">
        <div class="col-md-5">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}success{% endif %} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
    <!-- END MESSAGES SECTION -->

    
    <!-- PRODUCT SECTION -->
    <div class="mt-5">
        <h3 class="text-center mb-4">Recommended Skincare & Makeup</h3>

        <div class="row">
            {% for product in products %}
            <div class="col-md-3 mb-4">
                <div class="card h-100 shadow-sm">
                    <img src="{{ product.image.url }}"
                         class="card-img-top"
                         alt="{{ product.name }}">
                    <div class="card-body text-center">
                        <h6 class="fw-bold">{{ product.name }}</h6>
                        <p class="small text-muted">{{ product.description }}</p>
                        <p class="fw-bold text-success">KSh {{ product.price }}</p>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-center text-muted">
                Products will appear after analysis.
            </p>
            {% endfor %}
        </div>
    </div>

</div>

<!-- STYLES -->
<style>
.camera-wrapper {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    overflow: hidden;
    border: 4px solid #ff69b4;
}

.camera-wrapper video,
.camera-wrapper canvas {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

canvas {
    display: none;
}
</style>



<script>
// Start camera when page loads
window.onload = function() {
    startCamera();
};

function startCamera() {
    const video = document.getElementById('video');

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                video.srcObject = stream;
                video.play();
            })
            .catch(function(err) {
                console.error("Camera error:", err);
                alert("Cannot access camera. Please allow camera permissions.");
            });
    } else {
        alert("Your browser doesn't support camera access.");
    }
}

// Capture Image - SIMPLE AND RELIABLE
let capturedImageData = null;
function captureImage() {
    console.log("Trying to capture image...");

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const imageInput = document.getElementById('captured_image');

    if (!video || !canvas) {
        alert("Camera not ready. Please refresh page.");
        return;
    }

    if (!video.videoWidth || !video.videoHeight) {
        alert('Camera not ready yet. Please wait a moment and try again.');
        return;
    }

    // Create a temporary canvas to capture image
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = video.videoWidth;
    tempCanvas.height = video.videoHeight;
    const ctx = tempCanvas.getContext('2d');

    // Draw video frame to canvas
    ctx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);

    // Convert to base64
    capturedImageData = tempCanvas.toDataURL('image/jpeg', 0.8);

    // Save to hidden input
    if (imageInput) imageInput.value = capturedImageData;

    // Show on screen canvas and hide video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);

    canvas.style.display = 'block';
    video.style.display = 'none';

    // Stop camera
    const stream = video.srcObject;
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }

    // Visual feedback
    const captureBtn = document.querySelector('.btn-outline-primary');
    if (captureBtn) {
        captureBtn.textContent = 'âœ… Image Captured!';
        captureBtn.className = 'btn btn-success w-100 mb-3 rounded-pill';
    }

    console.log("Image captured successfully!");
}

// Analyze - SUPER SIMPLE
function submitAnalysis() {
    console.log("Submitting analysis...");

    const imageInput = document.getElementById('captured_image');

    if (!imageInput || !imageInput.value || imageInput.value.length < 100) {
        alert("âŒ Please capture an image first!");
        return false;
    }

    // Show loading
    const loading = document.getElementById('loadingOverlay');
    if (loading) {
        loading.style.display = 'block';
    }

    // Submit the form
    document.getElementById('analysisForm').submit();

    return true;
}
</script>

{% endblock %}
        const canvas = document.getElementById('canvas');
        const imageInput = document.getElementById('captured_image');

        if (!video || !canvas) {
            alert("Camera not ready. Please refresh page.");
            return;
        }

        if (!video.videoWidth || !video.videoHeight) {
            alert('Camera not ready yet. Please wait a moment and try again.');
            return;
        }

        // Create a temporary canvas to capture image
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = video.videoWidth;
        tempCanvas.height = video.videoHeight;
        const ctx = tempCanvas.getContext('2d');

        // Draw video frame to canvas
        ctx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);

        // Convert to base64
        capturedImageData = tempCanvas.toDataURL('image/jpeg', 0.8);

        // Save to hidden input
        if (imageInput) imageInput.value = capturedImageData;

        // Show on screen canvas and hide video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        canvas.style.display = 'block';
        video.style.display = 'none';

        // Stop camera
        const stream = video.srcObject;
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }

        // Visual feedback
        const captureBtn = document.querySelector('.btn-outline-primary');
        if (captureBtn) {
            captureBtn.textContent = 'âœ… Image Captured!';
            captureBtn.className = 'btn btn-success w-100 mb-3 rounded-pill';
        }

        console.log("Image captured successfully!");
    }

    // Analyze - SUPER SIMPLE
    function submitAnalysis() {
        console.log("Submitting analysis...");

        const imageInput = document.getElementById('captured_image');

        if (!imageInput || !imageInput.value || imageInput.value.length < 100) {
            alert("âŒ Please capture an image first!");
            return false;
        }

        // Show loading
        const loading = document.getElementById('loadingOverlay');
        if (loading) {
            loading.style.display = 'block';
        }

        // Submit the form
        document.getElementById('analysisForm').submit();

        return true;
    }
    </script>
